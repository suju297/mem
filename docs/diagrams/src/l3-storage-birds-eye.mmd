flowchart TB
  classDef fs fill:#ECFEFF,stroke:#0E7490,stroke-width:1.8px,color:#083344
  classDef db fill:#FAF5FF,stroke:#9333EA,stroke-width:1.8px,color:#3B0764
  classDef fts fill:#FEFCE8,stroke:#CA8A04,stroke-width:1.8px,color:#422006
  classDef xfer fill:#ECFDF5,stroke:#16A34A,stroke-width:1.8px,color:#052E16

  subgraph HOST["Host Filesystem"]
    direction LR
    CFG["Config files<br/>&lt;config_dir&gt;/config.toml<br/>&lt;config_dir&gt;/mcp.manager.json"]:::fs
    DATA["Repo DB file<br/>&lt;data_dir&gt;/repos/&lt;repo_id&gt;/memory.db"]:::fs
    WAL["SQLite sidecars<br/>memory.db-wal / memory.db-shm"]:::fs
    SHARE["Share bundle<br/>&lt;repo_root&gt;/mempack-share/<br/>manifest.json, memories.jsonl, README.md"]:::xfer
  end

  subgraph SQL["SQLite Logical Groups"]
    direction LR
    CORE["Schema in memory.db"]:::db
    SCOPE["Scope + state<br/>repos, state_current, state_history, threads"]:::db
    CONTENT["Knowledge content<br/>memories, artifacts, chunks, links"]:::db
    EMB["Embeddings<br/>embeddings, embedding_queue"]:::db
    META["meta"]:::db
    SEARCH["Search index<br/>memories_fts, chunks_fts"]:::fts
  end

  CFG -. "selects data_dir + runtime config" .-> DATA
  DATA --> CORE
  CORE --> SCOPE
  CORE --> CONTENT
  CORE --> EMB
  CORE --> META
  DATA --> WAL
  CONTENT --> SEARCH
  SHARE -. "share export/import" .- DATA
